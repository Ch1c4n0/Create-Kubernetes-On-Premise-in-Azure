# Kubernetes VM Setup Guide (English)

## 1. Set the hostname

**Master:**
```
sudo hostnamectl set-hostname "k8smaster" && exec bash
```
Explanation: Sets the master server's hostname for easy identification on the network.

**Node 01:**
```
sudo hostnamectl set-hostname "k8sworker1" && exec bash
```
Explanation: Sets the hostname for the first worker node.

**Node 02:**
```
sudo hostnamectl set-hostname "k8sworker2" && exec bash
```
Explanation: Sets the hostname for the second worker node.

## 2. Configure /etc/hosts
Add the following lines on all servers:
```
10.0.0.4    k8smaster
10.0.0.5    k8sworker1
10.0.0.6    k8sworker2
```
Explanation: Allows servers to communicate using friendly names.

## 3. Disable Swap & Adjust Kernel Parameters
```
sudo swapoff -a
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
```
Explanation: Kubernetes requires swap to be disabled for proper operation.

## 4. Load required kernel modules
```
sudo tee /etc/modules-load.d/containerd.conf <<EOF
overlay
br_netfilter
EOF
sudo modprobe overlay
sudo modprobe br_netfilter
```
Explanation: Loads kernel modules needed for container networking.

## 5. Set kernel parameters
```
sudo tee /etc/sysctl.d/kubernetes.conf <<EOT
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOT
sudo sysctl --system
```
Explanation: Adjusts parameters to allow packet routing and filtering.

## 6. Install Docker and Containerd
```
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmour -o /etc/apt/trusted.gpg.d/docker.gpg
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
sudo apt update
sudo apt install -y containerd.io
```
Explanation: Installs the container runtime required for Kubernetes.

## 7. Configure containerd to use systemd as cgroup
```
containerd config default | sudo tee /etc/containerd/config.toml >/dev/null 2>&1
sudo sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
```
Explanation: Ensures containerd is compatible with Kubernetes.

## 8. Restart and enable containerd
```
sudo systemctl restart containerd
sudo systemctl enable containerd
```
Explanation: Applies the configuration and ensures the service starts automatically.

## 9. Add Kubernetes repository
```
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
```
Explanation: Adds the official repository to install Kubernetes components.

## 10. Install Kubectl, Kubeadm and Kubelet
```
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```
Explanation: Installs the main Kubernetes tools and prevents automatic updates.

## 11. Initialize the cluster (master only)
```
sudo kubeadm init --control-plane-endpoint=k8smaster
```
Explanation: Initializes the Kubernetes cluster on the master server.

## 12. Configure cluster access (master only)
```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```
Explanation: Allows the user to manage the cluster using kubectl.

## 13. Check cluster information
```
kubectl cluster-info
kubectl get nodes
```
Explanation: Shows information and status of cluster nodes.

## 14. Install Calico network plugin (master only)
```
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.0/manifests/calico.yaml
kubectl get pods -n kube-system
kubectl get nodes
```
Explanation: Installs Calico to manage container networking.

## 15. Add workers to the cluster
Get the `kubeadm join` command generated by the master and run it on the worker nodes.

## 16. Test the cluster
```
kubectl create ns demo-app
kubectl create deployment nginx-app --image nginx --replicas 2 --namespace demo-app
kubectl get deployment -n demo-app
kubectl get pods -n demo-app
kubectl expose deployment nginx-app -n demo-app --type NodePort --port 80
kubectl get svc -n demo-app
kubectl expose deployment php-app-deployment --type NodePort --port 80
kubectl get pods --all-namespaces -o wide
```
Explanation: Creates a namespace, a nginx deployment, exposes the service, and checks cluster operation.